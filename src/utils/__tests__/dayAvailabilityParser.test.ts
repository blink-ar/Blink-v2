import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { describe } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { expect } from 'vitest';
import { it } from 'vitest';
import { describe } from 'vitest';
import { describe } from 'vitest';
import { describe } from 'vitest';
import {
    parseDayAvailability,
    parseDayAvailabilityEnhanced,
    hasAnyDayAvailable,
    getAvailableDayNames,
    getPatternConfidence,
    type DayAvailability,
    type PatternMatch
} from '../dayAvailabilityParser';

describe('dayAvailabilityParser', () => {
    describe('parseDayAvailability', () => {
        describe('handles missing or invalid input', () => {
            it('should return null for undefined input', () => {
                expect(parseDayAvailability(undefined)).toBeNull();
            });

            it('should return null for empty string', () => {
                expect(parseDayAvailability('')).toBeNull();
            });

            it('should return null for whitespace-only string', () => {
                expect(parseDayAvailability('   ')).toBeNull();
            });
        });

        describe('handles "all days" patterns', () => {
            it('should parse "todos los días"', () => {
                const result = parseDayAvailability('todos los días');
                expect(result?.allDays).toBe(true);
                expect(result?.monday).toBe(true);
                expect(result?.sunday).toBe(true);
            });

            it('should parse "todos los dias" (without accent)', () => {
                const result = parseDayAvailability('todos los dias');
                expect(result?.allDays).toBe(true);
            });

            it('should parse "permanente"', () => {
                const result = parseDayAvailability('permanente');
                expect(result?.allDays).toBe(true);
            });

            it('should parse "siempre"', () => {
                const result = parseDayAvailability('siempre');
                expect(result?.allDays).toBe(true);
            });

            it('should be case insensitive for all days patterns', () => {
                const result = parseDayAvailability('TODOS LOS DÍAS');
                expect(result?.allDays).toBe(true);
            });
        });

        describe('handles weekend patterns', () => {
            it('should parse "fines de semana"', () => {
                const result = parseDayAvailability('fines de semana');
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
                expect(result?.monday).toBe(false);
                expect(result?.allDays).toBe(false);
            });

            it('should parse "fin de semana"', () => {
                const result = parseDayAvailability('fin de semana');
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
            });

            it('should parse "sábados y domingos"', () => {
                const result = parseDayAvailability('sábados y domingos');
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
            });

            it('should parse "sabados y domingos" (without accent)', () => {
                const result = parseDayAvailability('sabados y domingos');
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
            });
        });

        describe('handles weekday patterns', () => {
            it('should parse "lunes a viernes"', () => {
                const result = parseDayAvailability('lunes a viernes');
                expect(result?.monday).toBe(true);
                expect(result?.tuesday).toBe(true);
                expect(result?.wednesday).toBe(true);
                expect(result?.thursday).toBe(true);
                expect(result?.friday).toBe(true);
                expect(result?.saturday).toBe(false);
                expect(result?.sunday).toBe(false);
            });

            it('should parse "días hábiles"', () => {
                const result = parseDayAvailability('días hábiles');
                expect(result?.monday).toBe(true);
                expect(result?.friday).toBe(true);
                expect(result?.saturday).toBe(false);
                expect(result?.sunday).toBe(false);
            });

            it('should parse "dias habiles" (without accents)', () => {
                const result = parseDayAvailability('dias habiles');
                expect(result?.monday).toBe(true);
                expect(result?.friday).toBe(true);
            });

            it('should parse "días laborables"', () => {
                const result = parseDayAvailability('días laborables');
                expect(result?.monday).toBe(true);
                expect(result?.friday).toBe(true);
                expect(result?.saturday).toBe(false);
            });
        });

        describe('handles specific day mentions', () => {
            it('should parse "lunes"', () => {
                const result = parseDayAvailability('lunes');
                expect(result?.monday).toBe(true);
                expect(result?.tuesday).toBe(false);
            });

            it('should parse "martes"', () => {
                const result = parseDayAvailability('martes');
                expect(result?.tuesday).toBe(true);
                expect(result?.monday).toBe(false);
            });

            it('should parse "miércoles"', () => {
                const result = parseDayAvailability('miércoles');
                expect(result?.wednesday).toBe(true);
            });

            it('should parse "miercoles" (without accent)', () => {
                const result = parseDayAvailability('miercoles');
                expect(result?.wednesday).toBe(true);
            });

            it('should parse "jueves"', () => {
                const result = parseDayAvailability('jueves');
                expect(result?.thursday).toBe(true);
            });

            it('should parse "viernes"', () => {
                const result = parseDayAvailability('viernes');
                expect(result?.friday).toBe(true);
            });

            it('should parse "sábado"', () => {
                const result = parseDayAvailability('sábado');
                expect(result?.saturday).toBe(true);
            });

            it('should parse "sabado" (without accent)', () => {
                const result = parseDayAvailability('sabado');
                expect(result?.saturday).toBe(true);
            });

            it('should parse "domingo"', () => {
                const result = parseDayAvailability('domingo');
                expect(result?.sunday).toBe(true);
            });

            it('should parse multiple specific days', () => {
                const result = parseDayAvailability('lunes y miércoles');
                expect(result?.monday).toBe(true);
                expect(result?.wednesday).toBe(true);
                expect(result?.tuesday).toBe(false);
            });
        });

        describe('handles day ranges', () => {
            it('should parse "lunes a miércoles"', () => {
                const result = parseDayAvailability('lunes a miércoles');
                expect(result?.monday).toBe(true);
                expect(result?.tuesday).toBe(true);
                expect(result?.wednesday).toBe(true);
                expect(result?.thursday).toBe(false);
            });

            it('should parse "lunes a jueves"', () => {
                const result = parseDayAvailability('lunes a jueves');
                expect(result?.monday).toBe(true);
                expect(result?.tuesday).toBe(true);
                expect(result?.wednesday).toBe(true);
                expect(result?.thursday).toBe(true);
                expect(result?.friday).toBe(false);
            });

            it('should parse "martes a jueves"', () => {
                const result = parseDayAvailability('martes a jueves');
                expect(result?.monday).toBe(false);
                expect(result?.tuesday).toBe(true);
                expect(result?.wednesday).toBe(true);
                expect(result?.thursday).toBe(true);
                expect(result?.friday).toBe(false);
            });

            it('should parse "miércoles a viernes"', () => {
                const result = parseDayAvailability('miércoles a viernes');
                expect(result?.tuesday).toBe(false);
                expect(result?.wednesday).toBe(true);
                expect(result?.thursday).toBe(true);
                expect(result?.friday).toBe(true);
                expect(result?.saturday).toBe(false);
            });

            it('should parse "jueves a domingo"', () => {
                const result = parseDayAvailability('jueves a domingo');
                expect(result?.wednesday).toBe(false);
                expect(result?.thursday).toBe(true);
                expect(result?.friday).toBe(true);
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
            });

            it('should parse "viernes a domingo"', () => {
                const result = parseDayAvailability('viernes a domingo');
                expect(result?.thursday).toBe(false);
                expect(result?.friday).toBe(true);
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
            });

            it('should parse "sábado a domingo"', () => {
                const result = parseDayAvailability('sábado a domingo');
                expect(result?.friday).toBe(false);
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
            });
        });

        describe('handles edge cases and typos', () => {
            it('should handle extra whitespace', () => {
                const result = parseDayAvailability('  lunes   a   viernes  ');
                expect(result?.monday).toBe(true);
                expect(result?.friday).toBe(true);
            });

            it('should be case insensitive', () => {
                const result = parseDayAvailability('LUNES A VIERNES');
                expect(result?.monday).toBe(true);
                expect(result?.friday).toBe(true);
            });

            it('should handle mixed case', () => {
                const result = parseDayAvailability('Lunes A Viernes');
                expect(result?.monday).toBe(true);
                expect(result?.friday).toBe(true);
            });

            it('should store custom text for unrecognized patterns', () => {
                const result = parseDayAvailability('cada tercer día');
                expect(result?.customText).toBe('cada tercer día');
                expect(hasAnyDayAvailable(result!)).toBe(false);
            });

            it('should handle text with numbers', () => {
                const result = parseDayAvailability('del 1 al 15 de cada mes');
                expect(result?.customText).toBe('del 1 al 15 de cada mes');
            });

            it('should handle empty result gracefully', () => {
                const result = parseDayAvailability('texto sin días');
                expect(result?.customText).toBe('texto sin días');
            });
        });

        describe('handles complex text patterns', () => {
            it('should parse text with additional context', () => {
                const result = parseDayAvailability('Válido solo los fines de semana en restaurantes');
                expect(result?.saturday).toBe(true);
                expect(result?.sunday).toBe(true);
            });

            it('should parse text with punctuation', () => {
                const result = parseDayAvailability('Lunes, martes y miércoles.');
                expect(result?.monday).toBe(true);
                expect(result?.tuesday).toBe(true);
                expect(result?.wednesday).toBe(true);
            });

            it('should prioritize specific patterns over general text', () => {
                const result = parseDayAvailability('Disponible lunes a viernes en restaurantes');
                expect(result?.monday).toBe(true);
                expect(result?.friday).toBe(true);
                expect(result?.saturday).toBe(false);
            });
        });
    });

    describe('hasAnyDayAvailable', () => {
        it('should return true when allDays is true', () => {
            const availability: DayAvailability = {
                monday: false,
                tuesday: false,
                wednesday: false,
                thursday: false,
                friday: false,
                saturday: false,
                sunday: false,
                allDays: true,
            };
            expect(hasAnyDayAvailable(availability)).toBe(true);
        });

        it('should return true when any specific day is true', () => {
            const availability: DayAvailability = {
                monday: true,
                tuesday: false,
                wednesday: false,
                thursday: false,
                friday: false,
                saturday: false,
                sunday: false,
                allDays: false,
            };
            expect(hasAnyDayAvailable(availability)).toBe(true);
        });

        it('should return false when no days are available', () => {
            const availability: DayAvailability = {
                monday: false,
                tuesday: false,
                wednesday: false,
                thursday: false,
                friday: false,
                saturday: false,
                sunday: false,
                allDays: false,
            };
            expect(hasAnyDayAvailable(availability)).toBe(false);
        });
    });

    describe('getAvailableDayNames', () => {
        it('should return "Todos los días" when allDays is true', () => {
            const availability: DayAvailability = {
                monday: true,
                tuesday: true,
                wednesday: true,
                thursday: true,
                friday: true,
                saturday: true,
                sunday: true,
                allDays: true,
            };
            expect(getAvailableDayNames(availability)).toEqual(['Todos los días']);
        });

        it('should return specific day names when individual days are set', () => {
            const availability: DayAvailability = {
                monday: true,
                tuesday: false,
                wednesday: true,
                thursday: false,
                friday: true,
                saturday: false,
                sunday: false,
                allDays: false,
            };
            expect(getAvailableDayNames(availability)).toEqual(['Lunes', 'Miércoles', 'Viernes']);
        });

        it('should return empty array when no days are available', () => {
            const availability: DayAvailability = {
                monday: false,
                tuesday: false,
                wednesday: false,
                thursday: false,
                friday: false,
                saturday: false,
                sunday: false,
                allDays: false,
            };
            expect(getAvailableDayNames(availability)).toEqual([]);
        });

        it('should return weekend days', () => {
            const availability: DayAvailability = {
                monday: false,
                tuesday: false,
                wednesday: false,
                thursday: false,
                friday: false,
                saturday: true,
                sunday: true,
                allDays: false,
            };
            expect(getAvailableDayNames(availability)).toEqual(['Sábado', 'Domingo']);
        });
    });

    describe('Enhanced Pattern Recognition', () => {
        describe('parseDayAvailabilityEnhanced', () => {
            describe('handles restriction language patterns', () => {
                it('should parse "válido solo fines de semana" with high confidence', () => {
                    const result = parseDayAvailabilityEnhanced('válido solo fines de semana');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.sunday).toBe(true);
                    expect(result!.availability.monday).toBe(false);
                    expect(result!.match.pattern).toBe('weekendRestriction');
                    expect(result!.match.confidence).toBeGreaterThan(0.8);
                    expect(result!.match.isRestriction).toBe(true);
                    expect(result!.match.isNegation).toBe(false);
                });

                it('should parse "aplicable únicamente sábados y domingos"', () => {
                    const result = parseDayAvailabilityEnhanced('aplicable únicamente sábados y domingos');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.sunday).toBe(true);
                    expect(result!.availability.friday).toBe(false);
                    expect(result!.match.isRestriction).toBe(true);
                });

                it('should parse "válido solo días hábiles"', () => {
                    const result = parseDayAvailabilityEnhanced('válido solo días hábiles');
                    expect(result).not.toBeNull();
                    expect(result!.availability.monday).toBe(true);
                    expect(result!.availability.friday).toBe(true);
                    expect(result!.availability.saturday).toBe(false);
                    expect(result!.availability.sunday).toBe(false);
                    expect(result!.match.pattern).toBe('weekdayRestriction');
                    expect(result!.match.isRestriction).toBe(true);
                });

                it('should parse "aplicable únicamente lunes a viernes"', () => {
                    const result = parseDayAvailabilityEnhanced('aplicable únicamente lunes a viernes');
                    expect(result).not.toBeNull();
                    expect(result!.availability.monday).toBe(true);
                    expect(result!.availability.friday).toBe(true);
                    expect(result!.availability.saturday).toBe(false);
                    expect(result!.match.isRestriction).toBe(true);
                });

                it('should handle text without accents', () => {
                    const result = parseDayAvailabilityEnhanced('valido solo dias habiles');
                    expect(result).not.toBeNull();
                    expect(result!.availability.monday).toBe(true);
                    expect(result!.availability.friday).toBe(true);
                    expect(result!.availability.saturday).toBe(false);
                });
            });

            describe('handles negation and exclusion patterns', () => {
                it('should parse "no válido domingos"', () => {
                    const result = parseDayAvailabilityEnhanced('no válido domingos');
                    expect(result).not.toBeNull();
                    expect(result!.availability.sunday).toBe(false);
                    expect(result!.availability.monday).toBe(true);
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.allDays).toBe(false);
                    expect(result!.match.isNegation).toBe(true);
                });

                it('should parse "excepto domingo"', () => {
                    const result = parseDayAvailabilityEnhanced('excepto domingo');
                    expect(result).not.toBeNull();
                    expect(result!.availability.sunday).toBe(false);
                    expect(result!.availability.monday).toBe(true);
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.match.pattern).toBe('exceptDay');
                    expect(result!.match.isNegation).toBe(true);
                });

                it('should parse "excepto sábado"', () => {
                    const result = parseDayAvailabilityEnhanced('excepto sábado');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(false);
                    expect(result!.availability.sunday).toBe(true);
                    expect(result!.availability.friday).toBe(true);
                });

                it('should handle multiple exclusions', () => {
                    const result = parseDayAvailabilityEnhanced('no válido sábado domingo');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(false);
                    expect(result!.availability.sunday).toBe(false);
                    expect(result!.availability.friday).toBe(true);
                });
            });

            describe('handles time-based day range patterns', () => {
                it('should parse "lunes a viernes de 9 a 17hs"', () => {
                    const result = parseDayAvailabilityEnhanced('lunes a viernes de 9 a 17hs');
                    expect(result).not.toBeNull();
                    expect(result!.availability.monday).toBe(true);
                    expect(result!.availability.friday).toBe(true);
                    expect(result!.availability.saturday).toBe(false);
                    expect(result!.match.pattern).toBe('timeBasedRange');
                });

                it('should parse "martes a jueves de 10 a 16"', () => {
                    const result = parseDayAvailabilityEnhanced('martes a jueves de 10 a 16');
                    expect(result).not.toBeNull();
                    expect(result!.availability.monday).toBe(false);
                    expect(result!.availability.tuesday).toBe(true);
                    expect(result!.availability.wednesday).toBe(true);
                    expect(result!.availability.thursday).toBe(true);
                    expect(result!.availability.friday).toBe(false);
                });

                it('should handle wrap-around ranges like "viernes a domingo de 18 a 22"', () => {
                    const result = parseDayAvailabilityEnhanced('viernes a domingo de 18 a 22');
                    expect(result).not.toBeNull();
                    expect(result!.availability.thursday).toBe(false);
                    expect(result!.availability.friday).toBe(true);
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.sunday).toBe(true);
                    expect(result!.availability.monday).toBe(false);
                });
            });

            describe('handles "todos los" specific day patterns', () => {
                it('should parse "todos los martes"', () => {
                    const result = parseDayAvailabilityEnhanced('todos los martes');
                    expect(result).not.toBeNull();
                    expect(result!.availability.tuesday).toBe(true);
                    expect(result!.availability.monday).toBe(false);
                    expect(result!.availability.wednesday).toBe(false);
                    expect(result!.match.pattern).toBe('allDaysSpecific');
                    expect(result!.match.isRestriction).toBe(true);
                });

                it('should parse "todos los sábados"', () => {
                    const result = parseDayAvailabilityEnhanced('todos los sábados');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.sunday).toBe(false);
                });

                it('should handle days without accents', () => {
                    const result = parseDayAvailabilityEnhanced('todos los miercoles');
                    expect(result).not.toBeNull();
                    expect(result!.availability.wednesday).toBe(true);
                    expect(result!.availability.tuesday).toBe(false);
                });
            });

            describe('confidence scoring system', () => {
                it('should assign high confidence to restriction patterns', () => {
                    const result = parseDayAvailabilityEnhanced('válido solo fines de semana');
                    expect(result!.match.confidence).toBeGreaterThan(0.85);
                });

                it('should assign medium confidence to context patterns', () => {
                    const result = parseDayAvailabilityEnhanced('fines de semana');
                    expect(result!.match.confidence).toBeGreaterThanOrEqual(0.6);
                    expect(result!.match.confidence).toBeLessThan(0.8);
                });

                it('should boost confidence for multiple restriction indicators', () => {
                    const result1 = parseDayAvailabilityEnhanced('fines de semana');
                    const result2 = parseDayAvailabilityEnhanced('válido solo fines de semana');
                    expect(result2!.match.confidence).toBeGreaterThan(result1!.match.confidence);
                });

                it('should reduce confidence for very long text', () => {
                    const shortText = 'válido solo fines de semana';
                    const longText = 'Este beneficio es válido solo fines de semana en restaurantes seleccionados de la ciudad durante los meses de verano y con restricciones adicionales que aplican según términos y condiciones';

                    const result1 = parseDayAvailabilityEnhanced(shortText);
                    const result2 = parseDayAvailabilityEnhanced(longText);

                    expect(result2!.match.confidence).toBeLessThan(result1!.match.confidence);
                });
            });

            describe('pattern priority and precedence', () => {
                it('should prioritize restriction patterns over general patterns', () => {
                    const result = parseDayAvailabilityEnhanced('todos los días válido solo fines de semana');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.sunday).toBe(true);
                    expect(result!.availability.monday).toBe(false);
                    expect(result!.match.pattern).toBe('weekendRestriction');
                });

                it('should prioritize negation patterns appropriately', () => {
                    const result = parseDayAvailabilityEnhanced('todos los días excepto domingo');
                    expect(result).not.toBeNull();
                    expect(result!.availability.sunday).toBe(false);
                    expect(result!.availability.monday).toBe(true);
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.match.isNegation).toBe(true);
                });
            });

            describe('edge cases and error handling', () => {
                it('should return null for empty input', () => {
                    expect(parseDayAvailabilityEnhanced('')).toBeNull();
                    expect(parseDayAvailabilityEnhanced(undefined)).toBeNull();
                    expect(parseDayAvailabilityEnhanced('   ')).toBeNull();
                });

                it('should handle mixed case input', () => {
                    const result = parseDayAvailabilityEnhanced('VÁLIDO SOLO FINES DE SEMANA');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.sunday).toBe(true);
                });

                it('should handle text with extra punctuation', () => {
                    const result = parseDayAvailabilityEnhanced('Válido solo fines de semana.');
                    expect(result).not.toBeNull();
                    expect(result!.availability.saturday).toBe(true);
                    expect(result!.availability.sunday).toBe(true);
                });

                it('should return null for unrecognized patterns', () => {
                    const result = parseDayAvailabilityEnhanced('cada tercer día del mes');
                    expect(result).toBeNull();
                });
            });
        });

        describe('getPatternConfidence', () => {
            it('should return confidence score for valid patterns', () => {
                const confidence = getPatternConfidence('válido solo fines de semana');
                expect(confidence).toBeGreaterThan(0.8);
            });

            it('should return 0 for invalid patterns', () => {
                const confidence = getPatternConfidence('texto sin patrones de días');
                expect(confidence).toBe(0);
            });

            it('should return 0 for empty input', () => {
                expect(getPatternConfidence('')).toBe(0);
                expect(getPatternConfidence(undefined)).toBe(0);
            });
        });

        describe('backward compatibility', () => {
            it('should maintain backward compatibility with parseDayAvailability', () => {
                const enhanced = parseDayAvailabilityEnhanced('válido solo fines de semana');
                const regular = parseDayAvailability('válido solo fines de semana');

                expect(regular).not.toBeNull();
                expect(regular!.saturday).toBe(enhanced!.availability.saturday);
                expect(regular!.sunday).toBe(enhanced!.availability.sunday);
                expect(regular!.monday).toBe(enhanced!.availability.monday);
            });

            it('should store custom text for unrecognized patterns in backward compatible mode', () => {
                const result = parseDayAvailability('cada tercer día');
                expect(result).not.toBeNull();
                expect(result!.customText).toBe('cada tercer día');
            });

            it('should work with existing test cases', () => {
                // Test that existing functionality still works
                expect(parseDayAvailability('lunes a viernes')?.monday).toBe(true);
                expect(parseDayAvailability('fines de semana')?.saturday).toBe(true);
                expect(parseDayAvailability('todos los días')?.allDays).toBe(true);
            });
        });
    });
});